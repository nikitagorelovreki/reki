# Тестирование системы Reki Control Panel

## Обзор

Система тестирования построена на функциональных тестах с реальной базой данных, что позволяет:

- Документировать функциональность системы
- Обеспечивать стабильность при рефакторингах
- Проверять интеграцию между компонентами
- Восстанавливать продуктовые свойства системы

## Структура тестов

```
├── jest.config.js              # Конфигурация Jest
├── jest.setup.js              # Настройки и утилиты для тестов
├── packages/
│   ├── api-server/
│   │   └── __tests__/
│   │       ├── clients.test.ts      # Тесты API клиентов
│   │       ├── devices.test.ts      # Тесты API устройств
│   │       ├── forms.test.ts        # Тесты API форм и записей
│   │       ├── integration.test.ts   # Интеграционные тесты
│   │       └── seed.test.ts         # Тесты сид скрипта
│   └── frontend/
│       └── __tests__/
│           ├── FormsPage.test.tsx   # Тесты страницы форм
│           └── RadarChart.test.tsx   # Тесты компонента графика
```

## Типы тестов

### 1. API тесты (packages/api-server/**tests**/)

**Функциональные тесты с реальной базой данных**

- **clients.test.ts** - CRUD операции с клиентами
- **devices.test.ts** - Управление устройствами и их статусами
- **forms.test.ts** - Шаблоны форм и записи форм
- **integration.test.ts** - Полные сценарии работы с системой
- **seed.test.ts** - Проверка корректности тестовых данных

### 2. Фронтенд тесты (packages/frontend/**tests**/)

**Тесты компонентов с моками API**

- **FormsPage.test.tsx** - Страница форм с фильтрацией и пагинацией
- **RadarChart.test.tsx** - Компонент радарного графика

## Запуск тестов

### Установка зависимостей

```bash
npm install
```

### Запуск всех тестов

```bash
npm test
```

### Запуск тестов с покрытием

```bash
npm run test:coverage
```

### Запуск тестов в режиме наблюдения

```bash
npm run test:watch
```

### Запуск конкретных тестов

```bash
# Только API тесты
npm run test:api

# Только интеграционные тесты
npm run test:integration

# Только тесты сид скрипта
npm run test:seed
```

## Настройка тестового окружения

### База данных

Тесты используют отдельную тестовую базу данных `reki_test`:

```bash
# Создание тестовой базы данных
createdb reki_test

# Или через Docker
docker exec -it postgres createdb -U postgres reki_test
```

### Переменные окружения

Создайте файл `.env.test`:

```env
NODE_ENV=test
DB_NAME=reki_test
DB_USER=postgres
DB_PASSWORD=postgres
DB_HOST=localhost
DB_PORT=5432
```

## Сценарии тестирования

### 1. Регистрация пациента и заполнение формы FIM

**Файл:** `integration.test.ts`

**Описание:** Полный цикл от регистрации пациента до заполнения формы FIM с данными "До" и "После"

**Проверяет:**

- Создание пациента с валидацией
- Создание шаблона формы FIM
- Заполнение формы с данными реабилитации
- Связи между записями форм, пациентами и шаблонами

### 2. Управление устройствами

**Файл:** `devices.test.ts`

**Описание:** Жизненный цикл устройства от создания до изменения статуса

**Проверяет:**

- Создание устройства с уникальным серийным номером
- Изменение статуса (IN_STOCK → AT_CLINIC)
- Обновление информации об устройстве
- Фильтрация и поиск устройств

### 3. Аналитика и отчеты

**Файл:** `integration.test.ts`

**Описание:** Получение статистики по всем сущностям системы

**Проверяет:**

- Подсчет пациентов по статусам
- Статистика устройств по статусам
- Количество форм и записей
- Пагинация и фильтрация

### 4. Обработка ошибок

**Файл:** `integration.test.ts`

**Описание:** Проверка корректной обработки ошибок валидации

**Проверяет:**

- Валидация обязательных полей
- Проверка уникальности данных
- Обработка несуществующих ресурсов
- Проверка связей между сущностями

## Утилиты для тестов

### Глобальные утилиты (jest.setup.js)

```javascript
global.testUtils = {
  // Генерация тестовых данных
  generateTestClient(overrides = {})
  generateTestDevice(overrides = {})
  generateTestForm(overrides = {})

  // Ожидание и очистка
  wait(ms)
  cleanupTestData(db)
}
```

### Примеры использования

```javascript
// Создание тестового клиента
const client = global.testUtils.generateTestClient({
  firstName: "Иван",
  lastName: "Петров",
  status: "active_therapy",
});

// Очистка тестовых данных
await global.testUtils.cleanupTestData(db);
```

## Покрытие кода

### Цели покрытия

- **API endpoints:** 100%
- **Валидация данных:** 100%
- **Обработка ошибок:** 100%
- **Интеграционные сценарии:** 100%
- **Компоненты фронтенда:** 90%+

### Генерация отчета

```bash
npm run test:coverage
```

Отчет будет доступен в `coverage/index.html`

## Лучшие практики

### 1. Изоляция тестов

- Каждый тест очищает данные перед выполнением
- Используется отдельная тестовая база данных
- Моки для внешних зависимостей

### 2. Описательные названия

```javascript
it("должен создавать нового клиента с валидацией обязательных полей", async () => {
  // тест
});
```

### 3. Проверка реальных данных

```javascript
// Проверяем не только ответ API, но и данные в базе
const savedClient = await db("clients").where("id", response.body.id).first();
expect(savedClient.full_name).toBe(newClient.fullName);
```

### 4. Тестирование граничных случаев

```javascript
it("должен возвращать 404 для несуществующего клиента", async () => {
  // тест
});
```

## Отладка тестов

### Логирование

```bash
# Включить логирование в тестах
DEBUG=* npm test
```

### Отладка конкретного теста

```bash
# Запуск одного теста
npm test -- --testNamePattern="должен создавать нового клиента"
```

### Инспекция базы данных

```bash
# Подключение к тестовой базе
psql -d reki_test -U postgres
```

## CI/CD интеграция

### GitHub Actions

```yaml
- name: Run tests
  run: npm test

- name: Upload coverage
  uses: codecov/codecov-action@v3
```

### Pre-commit hooks

```json
{
  "lint-staged": {
    "*.{ts,tsx}": ["npm run lint", "npm test -- --findRelatedTests"]
  }
}
```

## Расширение тестов

### Добавление нового API теста

1. Создайте файл в `packages/api-server/__tests__/`
2. Используйте структуру существующих тестов
3. Добавьте тесты для всех CRUD операций
4. Проверьте валидацию и обработку ошибок

### Добавление фронтенд теста

1. Создайте файл в `packages/frontend/__tests__/`
2. Используйте `@testing-library/react`
3. Мокайте API вызовы
4. Тестируйте пользовательские сценарии

### Обновление тестовых данных

1. Обновите `jest.setup.js` для новых утилит
2. Обновите сид скрипт при изменении схемы
3. Обновите моки в фронтенд тестах

## Заключение

Функциональные тесты обеспечивают:

- **Документацию** функциональности системы
- **Стабильность** при рефакторингах
- **Качество** кода и архитектуры
- **Быстрое обнаружение** регрессий

Тесты покрывают все основные сценарии использования системы и служат живой документацией для разработчиков.
